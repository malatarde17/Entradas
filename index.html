<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Entradas">
<meta name="theme-color" content="#0a0a0f">
<title>Entradas ¬∑ Castros & Carral</title>
<link rel="apple-touch-icon" href="icon-192.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0f; --s1:#111118; --s2:#18181f; --s3:#222230; --s4:#2a2a3a;
  --border:#252535; --border2:#363650;
  --castros:#f59e0b; --carral:#10b981;
  --text:#f0eff8; --text2:#8887a0; --text3:#4a4a62;
  --danger:#ef4444; --sat:env(safe-area-inset-top); --sab:env(safe-area-inset-bottom);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;font-size:14px;}
body{display:flex;flex-direction:column;min-height:100dvh;}

/* HEADER */
.hdr{
  display:flex;align-items:center;gap:10px;
  background:rgba(10,10,15,0.92);
  border-bottom:1px solid var(--border);
  padding:calc(var(--sat) + 10px) 14px 10px;
  position:sticky;top:0;z-index:50;
  backdrop-filter:blur(16px);
}
.logo{
  width:36px;height:36px;border-radius:10px;flex-shrink:0;
  background:linear-gradient(135deg,#f59e0b,#d97706);
  display:flex;align-items:center;justify-content:center;
  font-size:18px;box-shadow:0 2px 12px rgba(245,158,11,.35);
}
.hdr-title{flex:1;min-width:0;}
.hdr-title strong{display:block;font-size:14px;font-weight:700;letter-spacing:-.3px;}
.hdr-title small{font-size:10px;color:var(--text3);}

/* Tienda toggle */
.tgl{display:flex;background:var(--s3);border:1px solid var(--border);border-radius:10px;padding:3px;gap:3px;}
.tgl-btn{
  padding:5px 13px;border-radius:7px;border:none;cursor:pointer;
  font-family:'Inter',sans-serif;font-weight:600;font-size:11px;
  letter-spacing:.2px;transition:all .18s;color:var(--text3);background:transparent;
}
.tgl-btn.on-c{background:var(--castros);color:#000;box-shadow:0 1px 8px rgba(245,158,11,.4);}
.tgl-btn.on-r{background:var(--carral);color:#000;box-shadow:0 1px 8px rgba(16,185,129,.4);}

.hdr-end{display:flex;gap:6px;align-items:center;}
.xls-btn{
  height:34px;padding:0 13px;background:#166534;border:1px solid #15803d;
  border-radius:9px;color:#dcfce7;font-family:'Inter',sans-serif;
  font-weight:600;font-size:11px;cursor:pointer;white-space:nowrap;
}
.ico-btn{
  width:34px;height:34px;background:var(--s2);border:1px solid var(--border);
  border-radius:9px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:15px;color:var(--text2);transition:.15s;
}
.ico-btn:hover{border-color:var(--castros);color:var(--castros);}

/* LAYOUT */
.main{display:grid;grid-template-columns:1fr 1fr;flex:1;overflow:hidden;height:calc(100dvh - 57px);}
.pnl{overflow-y:auto;padding:18px;}
.pnl-l{border-right:1px solid var(--border);}

/* TABS */
.tabs{display:flex;background:var(--s2);border:1px solid var(--border);border-radius:11px;padding:4px;gap:4px;margin-bottom:18px;}
.tab{flex:1;padding:9px 6px;text-align:center;font-size:12px;font-weight:600;cursor:pointer;border-radius:8px;color:var(--text2);transition:.18s;}
.tab.on{background:var(--s3);color:var(--text);box-shadow:0 1px 6px rgba(0,0,0,.3);}

/* SECTION LABEL */
.lbl{
  font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;
  color:var(--text3);margin:16px 0 9px;display:flex;align-items:center;gap:8px;
}
.lbl:first-child{margin-top:0;}
.lbl::after{content:'';flex:1;height:1px;background:var(--border);}

/* DROP ZONE */
.dz{
  background:var(--s1);border:1.5px dashed var(--border2);border-radius:11px;
  padding:26px 16px;text-align:center;cursor:pointer;transition:.2s;margin-bottom:10px;
}
.dz:hover,.dz.over{border-color:var(--castros);background:rgba(245,158,11,.04);}
.dz-ico{font-size:30px;margin-bottom:7px;}
.dz-txt{font-size:12px;color:var(--text2);line-height:1.5;}
.dz-txt b{color:var(--castros);}

.img-prev{display:none;border-radius:11px;overflow:hidden;margin-bottom:10px;position:relative;}
.img-prev img{width:100%;max-height:200px;object-fit:contain;background:#000;display:block;}
.img-ov{position:absolute;top:8px;right:8px;}
.cam-box{display:none;border-radius:11px;overflow:hidden;background:#000;margin-bottom:10px;}
#cam-video{width:100%;max-height:250px;object-fit:cover;display:block;}

/* BUTTONS */
.btn{
  padding:9px 14px;border-radius:9px;border:1px solid var(--border);
  background:var(--s2);color:var(--text);font-family:'Inter',sans-serif;
  font-weight:500;font-size:12px;cursor:pointer;transition:.15s;
  display:inline-flex;align-items:center;justify-content:center;gap:6px;min-height:38px;
}
.btn:hover{border-color:var(--border2);background:var(--s3);}
.btn-p{background:var(--castros);color:#000;border-color:var(--castros);font-weight:700;}
.btn-p:hover{background:#d97706;border-color:#d97706;}
.btn-d{color:var(--danger);border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.06);}
.btn-d:hover{background:rgba(239,68,68,.14);}
.btn-sm{padding:5px 10px;font-size:11px;min-height:30px;border-radius:7px;}
.btn-fw{width:100%;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}

.scan-btn{
  width:100%;padding:14px;background:linear-gradient(135deg,var(--castros),#d97706);
  color:#000;border:none;border-radius:11px;font-family:'Inter',sans-serif;
  font-weight:700;font-size:13px;cursor:pointer;transition:.2s;margin-bottom:10px;
  box-shadow:0 2px 14px rgba(245,158,11,.25);
}
.scan-btn:hover{transform:translateY(-1px);box-shadow:0 4px 18px rgba(245,158,11,.35);}
.scan-btn:active{transform:none;}
.scan-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.busy{animation:pulse 1.1s infinite;}

/* FORM */
.fg{margin-bottom:10px;}
.fg label{display:block;font-size:10px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--text3);margin-bottom:5px;}
.fg input,.fg select{
  width:100%;background:var(--s2);border:1px solid var(--border);border-radius:9px;
  color:var(--text);padding:9px 12px;font-family:'Inter',sans-serif;font-size:13px;
  transition:.15s;min-height:40px;
}
.fg input:focus,.fg select:focus{outline:none;border-color:var(--castros);}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

.api-row{display:flex;gap:6px;margin-bottom:14px;}
.api-row input{
  flex:1;background:var(--s2);border:1px solid var(--border);border-radius:9px;
  color:var(--text);padding:9px 12px;font-family:'JetBrains Mono',monospace;font-size:11px;min-height:38px;
}
.api-row input:focus{outline:none;border-color:var(--castros);}

/* TABLE */
.tbl-wrap{overflow-x:auto;margin-bottom:8px;border:1px solid var(--border);border-radius:11px;}
table{width:100%;border-collapse:collapse;font-size:12px;}
thead th{
  background:var(--s2);color:var(--text3);font-size:9px;font-weight:600;
  letter-spacing:1.2px;text-transform:uppercase;padding:8px 7px;
  text-align:left;white-space:nowrap;border-bottom:1px solid var(--border);
}
tbody td{padding:4px 4px;border-bottom:1px solid rgba(37,37,53,.6);vertical-align:middle;}
tbody tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:rgba(245,158,11,.025);}
.ti{
  width:100%;background:transparent;border:1px solid transparent;border-radius:6px;
  color:var(--text);padding:4px 6px;font-family:'JetBrains Mono',monospace;font-size:11px;
}
.ti:focus{outline:none;border-color:var(--border2);background:var(--s2);}
.ts{background:var(--s2);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:4px 5px;font-size:11px;}
.tc{color:var(--castros);font-family:'JetBrains Mono',monospace;font-weight:500;white-space:nowrap;padding:4px 8px;}
.tbl-foot{display:flex;justify-content:space-between;align-items:center;padding:8px 4px;}
.tbl-sum{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--castros);}

/* SCANNING */
.scanning{display:none;text-align:center;padding:10px;font-size:12px;color:var(--text2);}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--border2);border-top-color:var(--castros);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px;}
.err-box{display:none;background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.25);border-radius:9px;padding:10px 12px;font-size:11px;color:var(--danger);margin-bottom:10px;}

/* RESULT */
.result-pnl{display:none;}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;}
.kpi{
  background:var(--s1);border:1px solid var(--border);border-radius:11px;
  padding:12px 8px;text-align:center;
}
.kpi-v{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--castros);line-height:1;margin-bottom:4px;}
.kpi-l{font-size:8px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);}

/* FILTER */
.fbar{display:flex;gap:6px;margin-bottom:12px;align-items:center;flex-wrap:wrap;}
.fbar span{font-size:10px;color:var(--text3);}
.fbtn{
  padding:5px 12px;border-radius:20px;border:1px solid var(--border);
  background:transparent;color:var(--text2);font-size:11px;font-weight:500;
  cursor:pointer;transition:.15s;min-height:28px;font-family:'Inter',sans-serif;
}
.fbtn:hover{border-color:var(--border2);}
.fbtn.fa{background:var(--s3);color:var(--text);border-color:var(--border2);}
.fbtn.fc{background:rgba(245,158,11,.15);color:var(--castros);border-color:rgba(245,158,11,.4);}
.fbtn.fr{background:rgba(16,185,129,.15);color:var(--carral);border-color:rgba(16,185,129,.4);}

/* ENTRY CARDS */
.entries{display:flex;flex-direction:column;gap:8px;}
.ecard{
  background:var(--s1);border:1px solid var(--border);border-radius:11px;
  padding:12px 14px;display:flex;align-items:center;gap:10px;transition:.15s;
}
.ecard:hover{border-color:var(--border2);}
.eleft{flex:1;min-width:0;}
.enum{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:13px;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.emeta{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ebadges{display:flex;gap:5px;align-items:center;margin-bottom:5px;flex-wrap:wrap;}
.badge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:9px;font-weight:600;letter-spacing:.2px;}
.b-ocr{background:rgba(99,102,241,.15);color:#818cf8;border:1px solid rgba(99,102,241,.3);}
.b-man{background:rgba(16,185,129,.12);color:#34d399;border:1px solid rgba(16,185,129,.3);}
.b-c{background:rgba(245,158,11,.12);color:var(--castros);border:1px solid rgba(245,158,11,.3);}
.b-r{background:rgba(16,185,129,.12);color:var(--carral);border:1px solid rgba(16,185,129,.3);}
.eright{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.eamt{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:15px;color:var(--castros);}

/* DEL BTN */
.del-btn{
  background:none;border:1px solid rgba(239,68,68,.25);color:var(--text3);
  cursor:pointer;font-size:14px;padding:4px 8px;border-radius:7px;
  transition:.15s;line-height:1;
}
.del-btn:hover{color:var(--danger);background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4);}

/* EMPTY */
.empty{text-align:center;padding:40px 20px;color:var(--text3);}
.empty-ico{font-size:36px;margin-bottom:10px;opacity:.3;}
.empty-txt{font-size:12px;line-height:1.6;}

/* EXPORT CARD */
.exp-card{background:var(--s1);border:1px solid var(--border);border-radius:11px;padding:14px;margin-top:14px;}
.exp-card h4{font-size:11px;font-weight:600;margin-bottom:10px;color:var(--text2);}
.exp-hint{font-size:10px;color:var(--text3);margin-top:8px;line-height:1.6;}

/* MODAL */
.modal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);
  z-index:1000;overflow-y:auto;padding:16px;
  padding-bottom:calc(16px + var(--sab));
  backdrop-filter:blur(6px);
}
.modal.open{display:block;}
.modal-box{
  max-width:860px;margin:0 auto;background:var(--s1);
  border:1px solid var(--border2);border-radius:16px;
  padding:20px;box-shadow:0 24px 64px rgba(0,0,0,.65);
}
.modal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.modal-title{font-size:15px;font-weight:700;}

/* TOAST */
.toast{
  position:fixed;bottom:calc(18px + var(--sab));left:50%;transform:translateX(-50%);
  background:var(--s2);border:1px solid var(--border2);border-radius:10px;
  padding:10px 20px;font-size:12px;font-weight:500;z-index:2000;
  display:none;box-shadow:0 4px 24px rgba(0,0,0,.5);white-space:nowrap;max-width:90vw;
}
.toast.ok{border-color:var(--carral);color:#34d399;}
.toast.err{border-color:var(--danger);color:var(--danger);}
.toast.info{border-color:var(--castros);color:var(--castros);}

/* PWA */
.pwa-bar{
  display:none;position:fixed;bottom:calc(68px + var(--sab));left:50%;
  transform:translateX(-50%);background:var(--s2);border:1px solid var(--castros);
  border-radius:14px;padding:13px 16px;z-index:1500;
  box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:340px;width:calc(100% - 32px);
}

/* MOBILE */
@media(max-width:768px){
  .main{grid-template-columns:1fr;height:auto;overflow:visible;}
  .pnl-l{border-right:none;border-bottom:1px solid var(--border);}
  .kpis{grid-template-columns:repeat(2,1fr);}
  .g2{grid-template-columns:1fr;}
}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
input[type=date]::-webkit-calendar-picker-indicator{filter:invert(.5);}
select option{background:var(--s2);}
</style>
</head>
<body>

<header class="hdr">
  <div class="logo">üì¶</div>
  <div class="hdr-title">
    <strong>Entradas</strong>
    <small id="hdr-sub">‚Äî</small>
  </div>
  <div class="tgl">
    <button class="tgl-btn" id="tb-c" onclick="setTienda('Castros')">Castros</button>
    <button class="tgl-btn" id="tb-r" onclick="setTienda('Carral')">Carral</button>
  </div>
  <div class="hdr-end">
    <button class="xls-btn" onclick="exportarExcel()">‚Üì Excel</button>
    <button class="ico-btn" onclick="borrarTodo()" title="Borrar todo">üóë</button>
  </div>
</header>

<div class="main">

<!-- ‚îÄ‚îÄ PANEL IZQ ‚îÄ‚îÄ -->
<div class="pnl pnl-l">

  <div class="lbl">Clave API Anthropic</div>
  <div class="api-row">
    <input type="password" id="api-key" placeholder="sk-ant-api03-‚Ä¶" oninput="localStorage.setItem('ocr_api_key',this.value)">
    <button class="btn btn-sm" onclick="toggleApiKey()">üëÅ</button>
  </div>

  <div class="tabs">
    <div class="tab on" id="tb-ocr" onclick="switchTab('ocr')">üì∑ Escanear OCR</div>
    <div class="tab"    id="tb-man" onclick="switchTab('manual')">‚úèÔ∏è Manual</div>
  </div>

  <!-- OCR TAB -->
  <div id="tab-ocr">
    <input type="file" id="fi-f" accept="image/*,application/pdf" style="display:none" onchange="handleFile(this.files[0])">
    <input type="file" id="fi-c" accept="image/*" capture="environment" style="display:none" onchange="handleFile(this.files[0])">
    <div class="dz" id="dz" ondragover="event.preventDefault();this.classList.add('over')" ondragleave="this.classList.remove('over')" ondrop="doDrop(event)" onclick="document.getElementById('fi-f').click()">
      <div class="dz-ico">üîç</div>
      <div class="dz-txt"><b>Pulsa o arrastra</b> el albar√°n<br>JPG ¬∑ PNG ¬∑ PDF</div>
    </div>
    <div class="row2">
      <button class="btn" onclick="document.getElementById('fi-f').click()">üìÅ Archivo</button>
      <button class="btn" id="cam-btn" onclick="abrirCam()">üì∏ C√°mara</button>
    </div>
    <div class="img-prev" id="img-prev">
      <img id="prev-img" src="" alt="">
      <div class="img-ov"><button class="btn btn-sm btn-d" onclick="limpiarImg()">‚úï</button></div>
    </div>
    <div class="cam-box" id="cam-box">
      <video id="cam-video" autoplay playsinline muted></video>
      <div style="display:flex;gap:8px;padding:8px;">
        <button class="btn btn-p" style="flex:1" onclick="capturar()">üì∑ Capturar</button>
        <button class="btn btn-d" onclick="cerrarCam()">‚úï</button>
      </div>
    </div>
    <button class="scan-btn" id="scan-btn" onclick="escanear()">üîç &nbsp;Analizar con OCR</button>
    <div class="scanning" id="scanning"><span class="spin"></span>Analizando albar√°n‚Ä¶</div>
    <div class="err-box" id="err-box"></div>

    <div class="result-pnl" id="result-pnl">
      <div class="lbl">Resultado ‚Äî revisa y confirma</div>
      <div class="g2">
        <div class="fg"><label>N¬∫ Albar√°n</label><input type="text" id="r-alb"></div>
        <div class="fg"><label>Fecha</label><input type="date" id="r-fecha"></div>
        <div class="fg"><label>Proveedor</label><input type="text" id="r-prov"></div>
        <div class="fg"><label>CIF</label><input type="text" id="r-cif"></div>
      </div>
      <div class="tbl-wrap"><table>
        <thead><tr><th>Art√≠culo</th><th>Ref.</th><th>Cant.</th><th>Ud.</th><th>P.Unit</th><th>IVA%</th><th>Total</th><th>Lote</th><th>Caduca</th><th></th></tr></thead>
        <tbody id="r-tb"></tbody>
      </table></div>
      <div class="tbl-foot">
        <button class="btn btn-sm" onclick="addLineaR()">+ L√≠nea</button>
        <span class="tbl-sum" id="r-tot">‚Ç¨0.00</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="btn btn-p" style="flex:1" onclick="confirmarOcr()">‚úì A√±adir al registro</button>
        <button class="btn" onclick="descartarOcr()">Descartar</button>
      </div>
    </div>
  </div><!-- /tab-ocr -->

  <!-- MANUAL TAB -->
  <div id="tab-man" style="display:none">
    <div class="lbl">Datos del albar√°n</div>
    <div class="g2">
      <div class="fg"><label>N¬∫ Albar√°n *</label><input type="text" id="m-alb" placeholder="ALB-001"></div>
      <div class="fg"><label>Fecha *</label><input type="date" id="m-fecha"></div>
      <div class="fg"><label>Proveedor *</label><input type="text" id="m-prov" placeholder="Nombre"></div>
      <div class="fg"><label>CIF</label><input type="text" id="m-cif" placeholder="B12345678"></div>
    </div>
    <div class="lbl">L√≠neas</div>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Art√≠culo</th><th>Ref.</th><th>Cant.</th><th>Ud.</th><th>P.Unit</th><th>IVA%</th><th>Total</th><th>Lote</th><th>Caduca</th><th></th></tr></thead>
      <tbody id="m-tb"></tbody>
    </table></div>
    <div class="tbl-foot">
      <button class="btn btn-sm" onclick="addLineaM()">+ L√≠nea</button>
      <span class="tbl-sum" id="m-tot">‚Ç¨0.00</span>
    </div>
    <div class="fg" style="margin-top:8px;"><label>Observaciones</label><input type="text" id="m-obs" placeholder="Opcional"></div>
    <button class="btn btn-p btn-fw" style="margin-top:8px;" onclick="guardarManual()">‚úì A√±adir entrada</button>
  </div>

</div><!-- /pnl-l -->

<!-- ‚îÄ‚îÄ PANEL DER ‚îÄ‚îÄ -->
<div class="pnl">
  <div class="kpis">
    <div class="kpi"><div class="kpi-v" id="k-n">0</div><div class="kpi-l">Entradas</div></div>
    <div class="kpi"><div class="kpi-v" id="k-l">0</div><div class="kpi-l">L√≠neas</div></div>
    <div class="kpi"><div class="kpi-v" id="k-i">‚Ç¨0</div><div class="kpi-l">Importe</div></div>
    <div class="kpi"><div class="kpi-v" id="k-o">0</div><div class="kpi-l">Via OCR</div></div>
  </div>
  <div class="fbar">
    <span>Ver:</span>
    <button class="fbtn fa" id="f-a" onclick="setFiltro('todas')">Todas</button>
    <button class="fbtn"    id="f-c" onclick="setFiltro('Castros')">Castros</button>
    <button class="fbtn"    id="f-r" onclick="setFiltro('Carral')">Carral</button>
  </div>
  <div id="entries" class="entries"></div>
  <div class="exp-card">
    <h4>üìä Exportar</h4>
    <button class="btn btn-fw" style="background:#166534;color:#dcfce7;border-color:#15803d;font-weight:600;" onclick="exportarExcel()">‚Üì Descargar todas las entradas (.xlsx)</button>
    <div class="exp-hint">Genera hojas separadas para Castros, Carral y una comparativa.</div>
  </div>
</div>

</div><!-- /main -->

<!-- MODAL EDICI√ìN -->
<div class="modal" id="modal-ed">
  <div class="modal-box">
    <div class="modal-hdr">
      <div class="modal-title">‚úèÔ∏è Editar entrada</div>
      <button class="btn btn-sm btn-d" onclick="cerrarEd()">‚úï Cerrar</button>
    </div>
    <div style="margin-bottom:16px;">
      <div style="font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:8px;">Tienda</div>
      <div class="tgl" style="width:fit-content;">
        <button class="tgl-btn" id="ed-tb-c" onclick="setEdTienda('Castros')">Castros</button>
        <button class="tgl-btn" id="ed-tb-r" onclick="setEdTienda('Carral')">Carral</button>
      </div>
      <input type="hidden" id="ed-tienda">
    </div>
    <div class="g2">
      <div class="fg"><label>N¬∫ Albar√°n *</label><input type="text" id="ed-alb"></div>
      <div class="fg"><label>Fecha *</label><input type="date" id="ed-fecha"></div>
      <div class="fg"><label>Proveedor *</label><input type="text" id="ed-prov"></div>
      <div class="fg"><label>CIF</label><input type="text" id="ed-cif"></div>
    </div>
    <div class="lbl" style="margin-top:4px;">L√≠neas de producto</div>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Art√≠culo</th><th>Ref.</th><th>Cant.</th><th>Ud.</th><th>P.Unit ‚Ç¨</th><th>IVA%</th><th>Total</th><th>Lote</th><th>Caduca</th><th></th></tr></thead>
      <tbody id="ed-tb"></tbody>
    </table></div>
    <div class="tbl-foot">
      <button class="btn btn-sm" onclick="addLineaEd()">+ L√≠nea</button>
      <span class="tbl-sum" id="ed-tot">‚Ç¨0.00</span>
    </div>
    <div class="fg" style="margin-top:10px;"><label>Observaciones</label><input type="text" id="ed-obs"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
      <button class="btn" onclick="cerrarEd()">Cancelar</button>
      <button class="btn btn-p" onclick="guardarEd()">‚úì Guardar cambios</button>
    </div>
  </div>
</div>

<!-- PWA BANNERS -->
<div class="pwa-bar" id="pwa-bar">
  <div style="display:flex;align-items:center;gap:12px;">
    <div style="font-size:26px;">üì¶</div>
    <div style="flex:1;"><div style="font-weight:700;font-size:13px;">Instalar app</div><div style="font-size:10px;color:var(--text2);margin-top:2px;">Acceso r√°pido desde pantalla de inicio</div></div>
    <button onclick="installPwa()" class="btn btn-p btn-sm">Instalar</button>
    <button onclick="document.getElementById('pwa-bar').style.display='none'" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:18px;">‚úï</button>
  </div>
</div>
<div class="pwa-bar" id="ios-hint" style="border-color:var(--carral);">
  <div style="text-align:center;">
    <div style="font-size:22px;margin-bottom:7px;">üì≤</div>
    <div style="font-weight:700;margin-bottom:6px;">Instalar en iPhone/iPad</div>
    <div style="font-size:11px;color:var(--text2);line-height:1.6;">Pulsa <b style="color:var(--castros)">‚¨Ü Compartir</b> en Safari<br>y luego <b style="color:var(--castros)">"A√±adir a pantalla de inicio"</b></div>
    <button onclick="document.getElementById('ios-hint').style.display='none'" class="btn btn-sm" style="margin-top:10px;">Entendido</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORE='entradas_v3';
let entries=[], tiendaA='Castros', filtro='todas';
let ocrL=[], manL=[], edL=[], editIdx=-1;
let camStream=null, imgB64=null, imgMime='image/jpeg';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onload=()=>{
  document.getElementById('api-key').value=localStorage.getItem('ocr_api_key')||'';
  document.getElementById('m-fecha').value=hoy();
  cargarLocal();
  setTienda(localStorage.getItem('tienda')||'Castros');
  addLineaM();
  renderEntries();
};

function hoy(){return new Date().toISOString().split('T')[0];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIENDA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTienda(t){
  tiendaA=t; localStorage.setItem('tienda',t);
  document.getElementById('tb-c').className='tgl-btn'+(t==='Castros'?' on-c':'');
  document.getElementById('tb-r').className='tgl-btn'+(t==='Carral' ?' on-r':'');
  document.getElementById('hdr-sub').textContent='Tienda activa: '+t;
}
function setEdTienda(t){
  document.getElementById('ed-tienda').value=t;
  document.getElementById('ed-tb-c').className='tgl-btn'+(t==='Castros'?' on-c':'');
  document.getElementById('ed-tb-r').className='tgl-btn'+(t==='Carral' ?' on-r':'');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab){
  document.getElementById('tab-ocr').style.display=tab==='ocr'?'':'none';
  document.getElementById('tab-man').style.display=tab==='manual'?'':'none';
  document.getElementById('tb-ocr').className='tab'+(tab==='ocr'?' on':'');
  document.getElementById('tb-man').className='tab'+(tab==='manual'?' on':'');
}
function toggleApiKey(){const i=document.getElementById('api-key');i.type=i.type==='password'?'text':'password';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILE / CAM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doDrop(e){e.preventDefault();document.getElementById('dz').classList.remove('over');if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0]);}
function handleFile(f){
  if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    imgB64=ev.target.result.split(',')[1]; imgMime=f.type||'image/jpeg';
    const img=document.getElementById('prev-img');
    img.src=f.type==='application/pdf'?'':ev.target.result;
    img.alt=f.type==='application/pdf'?'üìÑ '+f.name:'';
    document.getElementById('img-prev').style.display='block';
    cerrarCam(); toast('Cargado: '+f.name,'ok');
  };
  r.onerror=()=>toast('Error al leer el archivo','err');
  r.readAsDataURL(f);
}
function limpiarImg(){imgB64=null;document.getElementById('img-prev').style.display='none';document.getElementById('prev-img').src='';}
function abrirCam(){
  if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){document.getElementById('fi-c').click();return;}
  if(camStream){cerrarCam();return;}
  if(!navigator.mediaDevices?.getUserMedia){document.getElementById('fi-c').click();return;}
  navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}})
    .then(s=>{camStream=s;const v=document.getElementById('cam-video');v.srcObject=s;v.play();document.getElementById('cam-box').style.display='block';document.getElementById('cam-btn').textContent='‚úï Cerrar';})
    .catch(()=>document.getElementById('fi-c').click());
}
function capturar(){
  const v=document.getElementById('cam-video'),c=document.createElement('canvas');
  c.width=v.videoWidth;c.height=v.videoHeight;c.getContext('2d').drawImage(v,0,0);
  const d=c.toDataURL('image/jpeg',.9);imgB64=d.split(',')[1];imgMime='image/jpeg';
  document.getElementById('prev-img').src=d;document.getElementById('img-prev').style.display='block';
  cerrarCam();toast('Foto capturada','ok');
}
function cerrarCam(){
  if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;}
  document.getElementById('cam-box').style.display='none';
  document.getElementById('cam-btn').textContent='üì∏ C√°mara';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OCR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function escanear(){
  const key=document.getElementById('api-key').value.trim();
  if(!key){toast('Introduce la API Key primero','err');return;}
  if(!imgB64){toast('Sube o captura una imagen primero','err');return;}
  const btn=document.getElementById('scan-btn');
  btn.disabled=true;btn.classList.add('busy');
  document.getElementById('scanning').style.display='block';
  document.getElementById('err-box').style.display='none';
  document.getElementById('result-pnl').style.display='none';
  const prompt=`Analiza este albar√°n y extrae los datos en JSON. Responde SOLO con el JSON sin markdown:
{"albaran":"","fecha":"YYYY-MM-DD","proveedor":"","cif":"","lineas":[{"articulo":"","referencia":"","cantidad":0,"unidad":"","precio_unitario":0,"iva":10,"total":0,"lote":"","caducidad":""}]}
IVA Espa√±a: alimentos b√°sicos 4%, generales 10%, otros 21%.`;
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-opus-4-5-20251101',max_tokens:2000,messages:[{role:'user',content:[
        {type:'image',source:{type:'base64',media_type:imgMime,data:imgB64}},
        {type:'text',text:prompt}
      ]}]})
    });
    if(!res.ok){const e=await res.json().catch(()=>{});throw new Error(e?.error?.message||'Error '+res.status);}
    const data=await res.json();
    const txt=data.content[0].text.trim().replace(/```json|```/g,'').trim();
    const d=JSON.parse(txt);
    document.getElementById('r-alb').value=d.albaran||'';
    document.getElementById('r-fecha').value=d.fecha||hoy();
    document.getElementById('r-prov').value=d.proveedor||'';
    document.getElementById('r-cif').value=d.cif||'';
    ocrL=(d.lineas||[]).map(l=>({articulo:l.articulo||'',referencia:l.referencia||'',cantidad:l.cantidad||0,unidad:l.unidad||'ud',precio:l.precio_unitario||0,iva:l.iva||10,lote:l.lote||'',caducidad:l.caducidad||''}));
    renderTbl('r-tb',ocrL,'ocrL','r-tot');
    document.getElementById('result-pnl').style.display='block';
    document.getElementById('result-pnl').scrollIntoView({behavior:'smooth'});
    toast('‚úÖ OCR completado ‚Äî revisa los datos','ok');
  }catch(e){
    const b=document.getElementById('err-box');b.textContent='‚ùå '+e.message;b.style.display='block';
    toast('Error: '+e.message,'err');
  }
  btn.disabled=false;btn.classList.remove('busy');
  document.getElementById('scanning').style.display='none';
}

function addLineaR(){ocrL.push({articulo:'',referencia:'',cantidad:0,unidad:'ud',precio:0,iva:10,lote:'',caducidad:''});renderTbl('r-tb',ocrL,'ocrL','r-tot');}
function confirmarOcr(){
  const alb=document.getElementById('r-alb').value.trim(),prov=document.getElementById('r-prov').value.trim();
  if(!alb||!prov){toast('Albar√°n y proveedor obligatorios','err');return;}
  entries.unshift({albaran:alb,proveedor:prov,fecha:document.getElementById('r-fecha').value||hoy(),cif:document.getElementById('r-cif').value.trim(),lineas:JSON.parse(JSON.stringify(ocrL)),obs:'',origenOcr:true,tienda:tiendaA,ts:Date.now()});
  guardarLocal();renderEntries();document.getElementById('result-pnl').style.display='none';limpiarImg();ocrL=[];
  toast('‚úÖ Entrada OCR a√±adida','ok');
}
function descartarOcr(){document.getElementById('result-pnl').style.display='none';ocrL=[];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MANUAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addLineaM(){manL.push({articulo:'',referencia:'',cantidad:'',unidad:'kg',precio:'',iva:10,lote:'',caducidad:''});renderTbl('m-tb',manL,'manL','m-tot');}
function guardarManual(){
  const alb=document.getElementById('m-alb').value.trim(),prov=document.getElementById('m-prov').value.trim();
  if(!alb||!prov){toast('Albar√°n y proveedor obligatorios','err');return;}
  const ok=manL.filter(l=>(l.articulo||'').trim());
  if(!ok.length){toast('A√±ade al menos un art√≠culo','err');return;}
  entries.unshift({albaran:alb,proveedor:prov,fecha:document.getElementById('m-fecha').value||hoy(),cif:document.getElementById('m-cif').value.trim(),lineas:JSON.parse(JSON.stringify(ok)),obs:document.getElementById('m-obs').value.trim(),origenOcr:false,tienda:tiendaA,ts:Date.now()});
  guardarLocal();renderEntries();
  ['m-alb','m-cif','m-prov','m-obs'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('m-fecha').value=hoy();
  manL=[];addLineaM();
  toast('‚úÖ Entrada manual a√±adida','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ENTRIES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFiltro(f){
  filtro=f;
  document.getElementById('f-a').className='fbtn'+(f==='todas'   ?' fa':'');
  document.getElementById('f-c').className='fbtn'+(f==='Castros' ?' fc':'');
  document.getElementById('f-r').className='fbtn'+(f==='Carral'  ?' fr':'');
  renderEntries();
}

function calcTot(e){return e.lineas.reduce((s,l)=>s+(+l.cantidad||0)*(+l.precio||0)*(1+(+l.iva||0)/100),0);}

function renderEntries(){
  const filtradas=filtro==='todas'?entries:entries.filter(e=>e.tienda===filtro);
  // KPIs sobre FILTRADAS
  document.getElementById('k-n').textContent=filtradas.length;
  document.getElementById('k-l').textContent=filtradas.reduce((s,e)=>s+e.lineas.length,0);
  document.getElementById('k-i').textContent='‚Ç¨'+Math.round(filtradas.reduce((s,e)=>s+calcTot(e),0));
  document.getElementById('k-o').textContent=filtradas.filter(e=>e.origenOcr).length;

  const list=document.getElementById('entries');
  if(!filtradas.length){
    list.innerHTML=`<div class="empty"><div class="empty-ico">${entries.length===0?'üìã':'üè™'}</div><div class="empty-txt">${entries.length===0?'Sin entradas todav√≠a.<br>Escanea un albar√°n o a√±ade manualmente.':'Sin entradas para este filtro.'}</div></div>`;
    return;
  }
  // Construir HTML con √≠ndices al array GLOBAL entries
  let html='';
  filtradas.forEach(e=>{
    const i=entries.indexOf(e);
    const tot=calcTot(e);
    const bT=e.tienda==='Castros'?'<span class="badge b-c">Castros</span>':'<span class="badge b-r">Carral</span>';
    const bO=e.origenOcr?'<span class="badge b-ocr">OCR</span>':'<span class="badge b-man">Manual</span>';
    html+=`<div class="ecard">
      <div class="eleft">
        <div class="ebadges">${bT}${bO}</div>
        <div class="enum">${x(e.albaran)}</div>
        <div class="emeta">${e.fecha} ¬∑ ${x(e.proveedor)} ¬∑ ${e.lineas.length} l√≠nea(s)</div>
      </div>
      <div class="eright">
        <span class="eamt">‚Ç¨${tot.toFixed(2)}</span>
        <button class="btn btn-sm" onclick="abrirEd(${i})">‚úèÔ∏è</button>
        <button class="del-btn" onclick="borrarEntrada(${i})">‚úï</button>
      </div>
    </div>`;
  });
  list.innerHTML=html;
}

function borrarEntrada(i){
  if(!confirm('¬øEliminar esta entrada?'))return;
  entries.splice(i,1);guardarLocal();renderEntries();toast('Entrada eliminada','ok');
}
function borrarTodo(){
  if(!confirm('¬øBorrar TODOS los registros? No se puede deshacer.'))return;
  entries=[];guardarLocal();renderEntries();toast('Datos borrados','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDICI√ìN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function abrirEd(i){
  editIdx=i;
  const e=entries[i];
  edL=JSON.parse(JSON.stringify(e.lineas));
  document.getElementById('ed-alb').value=e.albaran||'';
  document.getElementById('ed-fecha').value=e.fecha||'';
  document.getElementById('ed-prov').value=e.proveedor||'';
  document.getElementById('ed-cif').value=e.cif||'';
  document.getElementById('ed-obs').value=e.obs||'';
  setEdTienda(e.tienda||'Castros');
  renderTbl('ed-tb',edL,'edL','ed-tot');
  document.getElementById('modal-ed').classList.add('open');
  document.body.style.overflow='hidden';
}
function cerrarEd(){
  document.getElementById('modal-ed').classList.remove('open');
  document.body.style.overflow='';
  editIdx=-1;edL=[];
}
function addLineaEd(){edL.push({articulo:'',referencia:'',cantidad:'',unidad:'ud',precio:'',iva:10,lote:'',caducidad:''});renderTbl('ed-tb',edL,'edL','ed-tot');}
function guardarEd(){
  const alb=document.getElementById('ed-alb').value.trim(),prov=document.getElementById('ed-prov').value.trim();
  if(!alb||!prov){toast('Albar√°n y proveedor obligatorios','err');return;}
  const ok=edL.filter(l=>(l.articulo||'').trim());
  if(!ok.length){toast('A√±ade al menos un art√≠culo','err');return;}
  entries[editIdx]={...entries[editIdx],tienda:document.getElementById('ed-tienda').value,albaran:alb,proveedor:prov,fecha:document.getElementById('ed-fecha').value||hoy(),cif:document.getElementById('ed-cif').value.trim(),obs:document.getElementById('ed-obs').value.trim(),lineas:ok};
  guardarLocal();renderEntries();cerrarEd();toast('‚úÖ Entrada actualizada','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABLE RENDERER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UDS=['kg','g','L','ml','ud','cajas','sacos'];

function renderTbl(tbodyId, arr, arrName, totId){
  const tbody=document.getElementById(tbodyId);
  if(!tbody)return;
  if(!arr.length){
    tbody.innerHTML=`<tr><td colspan="10" style="color:var(--text3);text-align:center;padding:14px;font-size:11px;">Pulsa "+ L√≠nea" para a√±adir</td></tr>`;
  } else {
    tbody.innerHTML=arr.map((l,i)=>{
      const tot=(+l.cantidad||0)*(+l.precio||0)*(1+(+l.iva||0)/100);
      const uOpts=UDS.map(u=>`<option${(l.unidad||'ud')===u?' selected':''}>${u}</option>`).join('');
      return `<tr>
        <td><input class="ti" style="min-width:130px" value="${x(l.articulo)}" placeholder="Art√≠culo" oninput="${arrName}[${i}].articulo=this.value"></td>
        <td><input class="ti" style="width:68px" value="${x(l.referencia)}" placeholder="Ref." oninput="${arrName}[${i}].referencia=this.value"></td>
        <td><input class="ti" type="number" style="width:60px" value="${l.cantidad||''}" oninput="${arrName}[${i}].cantidad=+this.value;updTot('${tbodyId}','${arrName}','${totId}',${i},this.closest('tr'))"></td>
        <td><select class="ts" onchange="${arrName}[${i}].unidad=this.value">${uOpts}</select></td>
        <td><input class="ti" type="number" style="width:66px" value="${l.precio||''}" oninput="${arrName}[${i}].precio=+this.value;updTot('${tbodyId}','${arrName}','${totId}',${i},this.closest('tr'))"></td>
        <td><input class="ti" type="number" style="width:44px" value="${l.iva||10}" oninput="${arrName}[${i}].iva=+this.value;updTot('${tbodyId}','${arrName}','${totId}',${i},this.closest('tr'))"></td>
        <td class="tc">‚Ç¨${tot.toFixed(2)}</td>
        <td><input class="ti" style="width:84px" value="${x(l.lote)}" placeholder="Lote" oninput="${arrName}[${i}].lote=this.value"></td>
        <td><input class="ti" type="date" value="${l.caducidad||''}" onchange="${arrName}[${i}].caducidad=this.value"></td>
        <td><button style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:15px;padding:3px 7px;border-radius:5px;" onmouseover="this.style.color='var(--danger)'" onmouseout="this.style.color='var(--text3)'" onclick="delLinea('${tbodyId}','${arrName}','${totId}',${i})">‚úï</button></td>
      </tr>`;
    }).join('');
  }
  calcAndSetTot(arrName, totId);
}

function getArr(name){return name==='ocrL'?ocrL:name==='manL'?manL:edL;}

function updTot(tbodyId, arrName, totId, i, tr){
  const arr=getArr(arrName);
  const tot=(+arr[i].cantidad||0)*(+arr[i].precio||0)*(1+(+arr[i].iva||0)/100);
  const tc=tr.querySelector('.tc');
  if(tc)tc.textContent='‚Ç¨'+tot.toFixed(2);
  calcAndSetTot(arrName, totId);
}

function calcAndSetTot(arrName, totId){
  const arr=getArr(arrName);
  const tot=arr.reduce((s,l)=>s+(+l.cantidad||0)*(+l.precio||0)*(1+(+l.iva||0)/100),0);
  const el=document.getElementById(totId);
  if(el)el.textContent='‚Ç¨'+tot.toFixed(2);
}

function delLinea(tbodyId, arrName, totId, i){
  getArr(arrName).splice(i,1);
  renderTbl(tbodyId,getArr(arrName),arrName,totId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXCEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportarExcel(){
  if(!entries.length){toast('No hay registros','err');return;}
  const wb=XLSX.utils.book_new();
  const H=['TIENDA','FECHA','N¬∫ ALBAR√ÅN','PROVEEDOR','CIF','ART√çCULO','REFERENCIA','CANTIDAD','UNIDAD','PRECIO UNIT.‚Ç¨','IVA%','TOTAL‚Ç¨','N¬∫ LOTE','CADUCIDAD','ORIGEN','OBS'];
  const C=[{wch:10},{wch:12},{wch:18},{wch:22},{wch:14},{wch:26},{wch:14},{wch:9},{wch:8},{wch:13},{wch:6},{wch:12},{wch:14},{wch:12},{wch:8},{wch:28}];
  function rows(list){
    const r=[H];
    list.forEach(e=>e.lineas.forEach(l=>{const t=(+l.cantidad||0)*(+l.precio||0)*(1+(+l.iva||0)/100);r.push([e.tienda||'',e.fecha,e.albaran,e.proveedor,e.cif||'',l.articulo,l.referencia||'',+l.cantidad||0,l.unidad||'',+l.precio||0,+l.iva||0,+t.toFixed(2),l.lote||'',l.caducidad||'',e.origenOcr?'OCR':'Manual',e.obs||'']);}));
    return r;
  }
  function addSheet(name,list){if(!list.length)return;const ws=XLSX.utils.aoa_to_sheet(rows(list));ws['!cols']=C;XLSX.utils.book_append_sheet(wb,ws,name);}
  addSheet('Todas',entries);
  addSheet('Castros',entries.filter(e=>e.tienda==='Castros'));
  addSheet('Carral',entries.filter(e=>e.tienda==='Carral'));
  const comp=[['TIENDA','ENTRADAS','L√çNEAS','TOTAL ‚Ç¨']];
  ['Castros','Carral'].forEach(t=>{const te=entries.filter(e=>e.tienda===t);comp.push([t,te.length,te.reduce((s,e)=>s+e.lineas.length,0),+te.reduce((s,e)=>s+calcTot(e),0).toFixed(2)]);});
  comp.push(['TOTAL',entries.length,entries.reduce((s,e)=>s+e.lineas.length,0),+entries.reduce((s,e)=>s+calcTot(e),0).toFixed(2)]);
  const wsc=XLSX.utils.aoa_to_sheet(comp);wsc['!cols']=[{wch:14},{wch:12},{wch:10},{wch:14}];XLSX.utils.book_append_sheet(wb,wsc,'Comparativa');
  const pm={};entries.forEach(e=>{if(!pm[e.proveedor])pm[e.proveedor]={n:0,t:0,u:'',ts:new Set()};pm[e.proveedor].n++;pm[e.proveedor].t+=calcTot(e);pm[e.proveedor].ts.add(e.tienda||'');if(e.fecha>pm[e.proveedor].u)pm[e.proveedor].u=e.fecha;});
  const pr=[['PROVEEDOR','TIENDAS','ENTRADAS','TOTAL‚Ç¨','√öLTIMA']];
  Object.entries(pm).sort((a,b)=>b[1].t-a[1].t).forEach(([p,d])=>pr.push([p,[...d.ts].join(' / '),d.n,+d.t.toFixed(2),d.u]));
  const wsp=XLSX.utils.aoa_to_sheet(pr);wsp['!cols']=[{wch:24},{wch:16},{wch:10},{wch:14},{wch:12}];XLSX.utils.book_append_sheet(wb,wsp,'Proveedores');
  XLSX.writeFile(wb,`entradas_${new Date().toISOString().split('T')[0]}.xlsx`);
  toast(`‚úÖ Excel exportado ‚Äî ${entries.length} entradas`,'ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function guardarLocal(){try{localStorage.setItem(STORE,JSON.stringify(entries));}catch(e){}}
function cargarLocal(){try{const s=localStorage.getItem(STORE);if(s)entries=JSON.parse(s);}catch(e){entries=[];}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function x(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(msg,type='ok'){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type;t.style.display='block';clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',3000);}
</script>

<script>
// SERVICE WORKER INLINE
if('serviceWorker' in navigator){
  const c=`const CA='ev3';self.addEventListener('install',e=>{e.waitUntil(self.skipWaiting());});self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim());});self.addEventListener('fetch',e=>{if(e.request.url.includes('api.anthropic.com'))return;e.respondWith(caches.match(e.request).then(c=>{if(c)return c;return fetch(e.request).then(r=>{if(r.ok&&e.request.method==='GET'){const cl=r.clone();caches.open(CA).then(ca=>ca.put(e.request,cl));}return r;}).catch(()=>c);}));});`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([c],{type:'application/javascript'}))).catch(()=>{});
}
// INSTALL PROMPT
let _p=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();_p=e;setTimeout(()=>{if(!window.matchMedia('(display-mode: standalone)').matches)document.getElementById('pwa-bar').style.display='block';},4000);});
function installPwa(){if(!_p)return;_p.prompt();_p.userChoice.then(()=>{document.getElementById('pwa-bar').style.display='none';_p=null;});}
const isIos=/iphone|ipad|ipod/i.test(navigator.userAgent),isSA=window.matchMedia('(display-mode: standalone)').matches||navigator.standalone;
if(isIos&&!isSA&&!localStorage.getItem('ios-shown')){setTimeout(()=>{document.getElementById('ios-hint').style.display='block';localStorage.setItem('ios-shown','1');},4000);}
</script>
</body>
</html>
